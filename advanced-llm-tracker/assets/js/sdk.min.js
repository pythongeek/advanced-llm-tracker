/**
 * Advanced LLM Tracker SDK
 * Privacy-first behavioral tracking for AI bot detection
 * @version 1.0.0
 */
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.ALLMT_SDK=factory())})(this,function(){"use strict";class ALLMT_SDK{constructor(config={}){this.config={endpoint:config.endpoint||"/wp-json/allmt/v1/track",nonce:config.nonce||"",sessionId:config.sessionId||this.generateSessionId(),samplingRate:config.samplingRate||100,detailedTrackingRate:config.detailedTrackingRate||10,batchSize:config.batchSize||100,batchInterval:config.batchInterval||50,enableMouseTracking:config.enableMouseTracking!==false,enableScrollTracking:config.enableScrollTracking!==false,enableViewportTracking:config.enableViewportTracking!==false,enableDOMTracking:config.enableDOMTracking!==false,differentialPrivacy:config.differentialPrivacy!==false,dpEpsilon:config.dpEpsilon||1,consentRequired:config.consentRequired!==false,maxEventsPerSession:config.maxEventsPerSession||1e3,debug:config.debug||false};this.eventQueue=[];this.sessionEvents=0;this.isTracking=false;this.mouseData={positions:[],lastTime:0,lastX:0,lastY:0};this.scrollData={positions:[],lastTime:0,lastDepth:0};this.consentGranted=!this.config.consentRequired;this.init()}init(){if(!this.shouldTrack()){this.log("Tracking disabled or not sampled");return}this.log("Initializing ALLMT SDK");this.setupEventListeners();this.startBatching();this.trackEvent("session_start",{url:window.location.href,referrer:document.referrer,timestamp:Date.now()})}shouldTrack(){if(this.config.samplingRate<100){const roll=Math.random()*100;if(roll>this.config.samplingRate){return false}}return true}setupEventListeners(){if(this.config.enableMouseTracking){document.addEventListener("mousemove",this.throttle(this.handleMouseMove.bind(this),50))}if(this.config.enableScrollTracking){window.addEventListener("scroll",this.throttle(this.handleScroll.bind(this),100))}document.addEventListener("click",this.handleClick.bind(this));document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this));window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this))}startBatching(){setInterval(()=>{this.flushQueue()},this.config.batchInterval)}handleMouseMove(e){if(!this.consentGranted)return;const now=Date.now();const x=e.clientX+window.scrollX;const y=e.clientY+window.scrollY;this.mouseData.positions.push({x:this.addNoise(x),y:this.addNoise(y),t:now});if(this.mouseData.positions.length>=10){this.analyzeMouseTrajectory()}}analyzeMouseTrajectory(){const positions=this.mouseData.positions;if(positions.length<2)return;let totalDistance=0;let directionChanges=0;let prevDirection=null;for(let i=1;i<positions.length;i++){const dx=positions[i].x-positions[i-1].x;const dy=positions[i].y-positions[i-1].y;const distance=Math.sqrt(dx*dx+dy*dy);totalDistance+=distance;if(i>1){const currentDirection=Math.atan2(dy,dx);if(prevDirection!==null){const angleDiff=Math.abs(currentDirection-prevDirection);if(angleDiff>Math.PI/4){directionChanges++}}prevDirection=currentDirection}}const duration=positions[positions.length-1].t-positions[0].t;const avgVelocity=duration>0?totalDistance/(duration/1e3):0;this.queueEvent("mouse_trajectory",{distance:Math.round(totalDistance),avgVelocity:Math.round(avgVelocity),directionChanges:directionChanges,duration:duration});this.mouseData.positions=[]}handleScroll(){if(!this.consentGranted)return;const now=Date.now();const depth=window.scrollY;const maxDepth=Math.max(document.body.scrollHeight-window.innerHeight,1);const scrollPercent=Math.round(depth/maxDepth*100);this.scrollData.positions.push({depth:scrollPercent,t:now});if(this.scrollData.positions.length>=5){this.analyzeScrollBehavior()}}analyzeScrollBehavior(){const positions=this.scrollData.positions;if(positions.length<2)return;let directionChanges=0;let maxVelocity=0;let prevDirection=null;for(let i=1;i<positions.length;i++){const depthDiff=positions[i].depth-positions[i-1].depth;const timeDiff=positions[i].t-positions[i-1].t;const velocity=timeDiff>0?Math.abs(depthDiff)/(timeDiff/1e3):0;maxVelocity=Math.max(maxVelocity,velocity);const currentDirection=depthDiff>=0?1:-1;if(prevDirection!==null&&currentDirection!==prevDirection){directionChanges++}prevDirection=currentDirection}this.queueEvent("scroll_behavior",{finalDepth:positions[positions.length-1].depth,maxVelocity:Math.round(maxVelocity),directionChanges:directionChanges});this.scrollData.positions=[]}handleClick(e){if(!this.consentGranted)return;const target=e.target;this.queueEvent("click",{x:this.addNoise(e.clientX+window.scrollX),y:this.addNoise(e.clientY+window.scrollY),elementTag:target.tagName,elementId:target.id||null,elementClass:target.className||null})}handleVisibilityChange(){this.queueEvent("visibility_change",{visible:!document.hidden})}handleBeforeUnload(){this.flushQueue()}queueEvent(type,data={}){if(this.sessionEvents>=this.config.maxEventsPerSession)return;this.sessionEvents++;this.eventQueue.push({type:type,data:data,pageUrl:window.location.href,timestamp:Date.now()/1e3});if(this.eventQueue.length>=this.config.batchSize){this.flushQueue()}}async flushQueue(){if(this.eventQueue.length===0)return;const events=this.eventQueue.splice(0,this.config.batchSize);try{await fetch(this.config.endpoint+"/batch",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":this.config.nonce},body:JSON.stringify({sessionId:this.config.sessionId,events:events})});this.log("Flushed",events.length,"events")}catch(error){this.log("Error flushing events:",error);this.eventQueue.unshift(...events)}}trackEvent(type,data={}){this.queueEvent(type,data)}addNoise(value){if(!this.config.differentialPrivacy)return value;const sensitivity=1;const epsilon=this.config.dpEpsilon;const noise=(Math.random()-.5)*2*sensitivity/epsilon;return Math.round(value+noise)}grantConsent(){this.consentGranted=true;this.log("Consent granted")}revokeConsent(){this.consentGranted=false;this.log("Consent revoked")}generateSessionId(){return Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b=>b.toString(16).padStart(2,"0")).join("")}throttle(fn,limit){let inThrottle;return function(...args){if(!inThrottle){fn.apply(this,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit)}}}log(...args){if(this.config.debug){console.log("[ALLMT]",...args)}}}return new ALLMT_SDK(typeof window!=="undefined"&&window.ALLMT_SDK_CONFIG||{})});
