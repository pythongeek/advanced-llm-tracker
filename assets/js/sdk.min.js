/**
 * Advanced LLM Tracker - JavaScript SDK (Minified)
 * @version 1.0.0
 */
!function(e,t){"use strict";const n=e.ALLMT_SDK_CONFIG||{endpoint:"/wp-json/allmt/v1/track",nonce:"",sessionId:"",samplingRate:100,detailedTrackingRate:10,batchSize:100,batchInterval:50,enableMouseTracking:!0,enableScrollTracking:!0,enableViewportTracking:!0,enableDOMTracking:!0,differentialPrivacy:!0,dpEpsilon:1,consentRequired:!0,maxEventsPerSession:1e3,debug:!1},s={initialized:!1,consentGiven:!1,eventQueue:[],eventCount:0,sessionStartTime:Date.now(),lastMouseX:0,lastMouseY:0,lastScrollY:0,lastEventTime:0,viewportWidth:e.innerWidth,viewportHeight:e.innerHeight,batchTimer:null,isSending:!1,mouseMoveBuffer:[],scrollBuffer:[],pageStartTime:Date.now(),currentPage:e.location.href,elementsObserved:new Set};function o(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function i(e,t){return t&&n.differentialPrivacy?Math.round(e+function(e){const t=Math.random()-.5;return-e*Math.sign(t)*Math.log(1-2*Math.abs(t))}(1/t)):e}const a={uuid:o,addNoise:i,throttle:function(e,t){let n;return function(...s){n||(e.apply(this,s),n=!0,setTimeout(()=>n=!1,t))}},debounce:function(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}},getElementPath:function(e){if(!e||e===t.body)return"";const n=[];let s=e;for(;s&&s!==t.body&&n.length<5;){let e=s.tagName.toLowerCase();if(s.id){e+="#"+s.id,n.unshift(e);break}s.className&&(e+="."+s.className.split(" ").slice(0,2).join(".")),n.unshift(e),s=s.parentElement}return n.join(" > ")},getVisibilityInfo:function(e){const t=e.getBoundingClientRect();return{visible:t.top<s.viewportHeight&&t.bottom>0&&t.left<s.viewportWidth&&t.right>0,percentVisible:Math.round(Math.max(0,Math.min(t.bottom,s.viewportHeight)-Math.max(t.top,0))*Math.max(0,Math.min(t.right,s.viewportWidth)-Math.max(t.left,0))/(t.width*t.height)*100),viewportX:Math.round(t.left),viewportY:Math.round(t.top)}},debug:function(...t){n.debug&&e.console&&console.log("[ALLMT]",...t)},compressEvents:function(e){if(!e.length)return e;const t=[];let n=null;for(const s of e)n&&s.type===n.type&&"mousemove"===s.type?(n.x2=s.x,n.y2=s.y,n.t2=s.t):(n&&t.push(n),n={...s});return n&&t.push(n),t}},r={mouseMove:(l=function(e){if(s.consentGiven&&!(s.eventCount>=n.maxEventsPerSession)){var t=Date.now(),o=i(e.clientX,n.dpEpsilon),r=i(e.clientY,n.dpEpsilon);(Math.abs(o-s.lastMouseX)>=5||Math.abs(r-s.lastMouseY)>=5)&&(s.mouseMoveBuffer.push({type:"mousemove",x:o,y:r,t:t-s.pageStartTime,vx:Math.round(o-s.lastMouseX),vy:Math.round(r-s.lastMouseY)}),s.lastMouseX=o,s.lastMouseY=r,s.mouseMoveBuffer.length>=10&&c())}},function(){let e=!1;return function(...t){e||(l.apply(this,t),e=!0,setTimeout(()=>e=!1,16))}})(),flushMouseBuffer:function(){if(0!==s.mouseMoveBuffer.length){var e=s.mouseMoveBuffer,t=0,n=0,o=0,i=null;for(let s=1;s<e.length;s++){var r=e[s].x-e[s-1].x,a=e[s].y-e[s-1].y,l=Math.sqrt(r*r+a*a),c=e[s].t-e[s-1].t;t+=l,n+=c;const d=Math.atan2(a,r);null!==i&&Math.abs(d-i)>.5&&o++,i=d}const c=t/(n||1),d=e.length>2?(e[e.length-1].vy-e[0].vy)/(e[e.length-1].t-e[0].t+1):0;u.queueEvent({type:"mouse_trajectory",data:{points:e.length,distance:Math.round(t),duration:n,avgVelocity:Math.round(100*c)/100,acceleration:Math.round(100*d)/100,directionChanges:o,startX:e[0].x,startY:e[0].y,endX:e[e.length-1].x,endY:e[e.length-1].y}}),s.mouseMoveBuffer=[]}},scroll:(d=function(){if(s.consentGiven&&!(s.eventCount>=n.maxEventsPerSession)){var t=Date.now(),o=e.scrollY||e.pageYOffset,i=e.scrollX||e.pageXOffset,a=t-s.pageStartTime,r=s.viewportHeight,l=Math.round(o/(t.documentElement.scrollHeight-r)*100)||0,c=Math.abs(o-s.lastScrollY),d=o>s.lastScrollY?"down":o<s.lastScrollY?"up":"none";s.scrollBuffer.push({y:o,depth:l,velocity:c,direction:d,time:a}),s.lastScrollY=o,s.scrollBuffer.length>=5&&h.flushScrollBuffer();const u=[25,50,75,90,100];for(const e of u){const t="scroll_milestone_"+e;l>=e&&!s.elementsObserved.has(t)&&(s.elementsObserved.add(t),u.queueEvent({type:"scroll_milestone",data:{depth:e,timeToReach:a}}))}}},function(){let e=!1;return function(...t){e||(d.apply(this,t),e=!0,setTimeout(()=>e=!1,100))}})(),flushScrollBuffer:function(){if(0!==s.scrollBuffer.length){var e=s.scrollBuffer.map(e=>e.velocity),t=e.reduce((e,t)=>e+t,0)/e.length,n=Math.max(...e),o=e.filter((e,t)=>t>0&&e.direction!==s.scrollBuffer[t-1].direction&&"none"!==e.direction).length;u.queueEvent({type:"scroll_behavior",data:{events:e.length,avgVelocity:Math.round(t),maxVelocity:n,directionChanges:o,finalDepth:s.scrollBuffer[s.scrollBuffer.length-1].depth,totalDistance:Math.abs(s.scrollBuffer[s.scrollBuffer.length-1].y-s.scrollBuffer[0].y)}}),s.scrollBuffer=[]}},click:function(e){if(s.consentGiven&&!(s.eventCount>=n.maxEventsPerSession)){var t=e.target,o=t.getBoundingClientRect();u.queueEvent({type:"click",data:{tag:t.tagName,id:t.id||null,class:t.className||null,text:t.textContent?t.textContent.substring(0,100):null,href:t.href||null,x:Math.round(e.clientX),y:Math.round(e.clientY),elementX:Math.round(e.clientX-o.left),elementY:Math.round(e.clientY-o.top),path:a.getElementPath(t)}})}},formInteraction:function(e){if(s.consentGiven&&!(s.eventCount>=n.maxEventsPerSession)&&"password"!==e.target.type){var t=e.target;u.queueEvent({type:"form_interaction",data:{action:e.type,tag:t.tagName,type:t.type||null,name:t.name||null,id:t.id||null,hasValue:t.value&&t.value.length>0}})}},visibilityChange:function(){u.queueEvent({type:"visibility_change",data:{hidden:t.hidden,timeOnPage:Date.now()-s.pageStartTime}})},pageUnload:function(){r.flushMouseBuffer(),r.flushScrollBuffer(),u.queueEvent({type:"page_exit",data:{timeOnPage:Date.now()-s.pageStartTime,scrollDepth:Math.round((e.scrollY/(t.documentElement.scrollHeight-s.viewportHeight))*100)||0,totalEvents:s.eventCount}}),s.eventQueue.length>0&&u.sendEvents(!0)},resize:(m=function(){s.viewportWidth=e.innerWidth,s.viewportHeight=e.innerHeight,u.queueEvent({type:"viewport_resize",data:{width:s.viewportWidth,height:s.viewportHeight}})},function(){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>m.apply(this,t),250)}})()};var l,d,m;const u={init:function(){if(s.initialized)return;if(a.debug("Initializing Advanced LLM Tracker SDK"),u.isKnownBot())return void a.debug("Known bot detected, skipping SDK initialization");if(n.consentRequired){if(s.consentGiven=u.checkConsent(),!s.consentGiven)return void a.debug("Consent not given, waiting for consent"),void u.waitForConsent()}else s.consentGiven=!0;u.setupEventListeners(),u.startBatchTimer(),s.initialized=!0,u.queueEvent({type:"page_view",data:{url:e.location.href,path:e.location.pathname,referrer:t.referrer,title:t.title,viewport:{width:s.viewportWidth,height:s.viewportHeight},screen:{width:e.screen.width,height:e.screen.height},timestamp:Date.now()}}),a.debug("SDK initialized successfully")},isKnownBot:function(){return[/bot/i,/crawler/i,/spider/i,/scraper/i,/curl/i,/wget/i,/python/i,/java\//i,/httpclient/i,/gptbot/i,/claudebot/i,/googlebot/i,/bingbot/i].some(t=>t.test(navigator.userAgent))},checkConsent:function(){if(e.wpConsentApi&&e.wpConsentApi.consent)return e.wpConsentApi.consent("statistics");if(e.cookieyes&&e.cookieyes._ckyConsent)return"yes"===e.cookieyes._ckyConsent.statistics;const n=t.cookie.match(/allmt_consent=([^;]+)/);return!!n&&"granted"===n[1]},waitForConsent:function(){t.addEventListener("wp_consent_api_changed",function(){s.consentGiven=u.checkConsent(),s.consentGiven&&!s.initialized&&u.init()});const e=setInterval(function(){s.consentGiven=u.checkConsent(),s.consentGiven&&(clearInterval(e),s.initialized||u.init())},1e3);setTimeout(function(){clearInterval(e)},3e4)},setupEventListeners:function(){n.enableMouseTracking&&100*Math.random()<n.detailedTrackingRate&&(t.addEventListener("mousemove",r.mouseMove,{passive:!0}),t.addEventListener("mouseenter",r.mouseMove,{passive:!0})),n.enableScrollTracking&&e.addEventListener("scroll",r.scroll,{passive:!0}),t.addEventListener("click",r.click,{passive:!0}),t.addEventListener("focus",r.formInteraction,{passive:!0}),t.addEventListener("blur",r.formInteraction,{passive:!0}),t.addEventListener("change",r.formInteraction,{passive:!0}),t.addEventListener("visibilitychange",r.visibilityChange),e.addEventListener("beforeunload",r.pageUnload),e.addEventListener("pagehide",r.pageUnload),e.addEventListener("resize",r.resize,{passive:!0}),n.enableViewportTracking&&"IntersectionObserver"in e&&u.setupIntersectionObserver()},setupIntersectionObserver:function(){const n=new IntersectionObserver(function(e){e.forEach(function(e){const n=e.target,o=n.tagName+(n.id?"#"+n.id:"");e.isIntersecting&&!s.elementsObserved.has(o)&&(s.elementsObserved.add(o),u.queueEvent({type:"element_visible",data:{tag:n.tagName,id:n.id||null,class:n.className||null,intersectionRatio:Math.round(100*e.intersectionRatio)/100,timeToVisible:Date.now()-s.pageStartTime}}))})},{root:null,rootMargin:"0px",threshold:[0,.1,.25,.5,.75,1]});t.querySelectorAll("h1, h2, h3, article, main, [data-track-visible]").forEach(e=>{n.observe(e)})},queueEvent:function(e){s.eventCount<n.maxEventsPerSession&&(e.sessionId=n.sessionId,e.pageUrl=s.currentPage,e.timestamp=Date.now(),s.eventQueue.push(e),s.eventCount++,s.eventQueue.length>=n.batchSize&&u.sendEvents())},startBatchTimer:function(){s.batchTimer=setInterval(function(){s.eventQueue.length>0&&u.sendEvents()},n.batchInterval)},sendEvents:function(o=!1){if(!s.isSending&&0!==s.eventQueue.length){s.isSending=!0;var i=s.eventQueue.splice(0,n.batchSize),a={session_id:n.sessionId,events:i,batch_time:Date.now()};if(o){var r=new Blob([JSON.stringify(a)],{type:"application/json"});navigator.sendBeacon(n.endpoint,r),s.isSending=!1}else fetch(n.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":n.nonce,"X-ALLMT-Session":n.sessionId},body:JSON.stringify(a),keepalive:!0}).then(e=>{if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).then(e=>{a.debug("Events sent successfully:",e)}).catch(e=>{a.debug("Error sending events:",e),i.length<n.batchSize&&s.eventQueue.unshift(...i)}).finally(function(){s.isSending=!1})}},grantConsent:function(){s.consentGiven=!0,t.cookie="allmt_consent=granted; path=/; max-age=31536000; SameSite=Lax",s.initialized||u.init()},revokeConsent:function(){s.consentGiven=!1,t.cookie="allmt_consent=denied; path=/; max-age=31536000; SameSite=Lax"},getStats:function(){return{eventCount:s.eventCount,timeOnPage:Date.now()-s.pageStartTime,scrollDepth:Math.round((e.scrollY/(t.documentElement.scrollHeight-s.viewportHeight))*100)||0,viewport:{width:s.viewportWidth,height:s.viewportHeight},consentGiven:s.consentGiven,initialized:s.initialized}},destroy:function(){s.batchTimer&&clearInterval(s.batchTimer),r.pageUnload(),s.initialized=!1}};function c(){r.flushMouseBuffer()}function h(){r.flushScrollBuffer()}e.ALLMT_SDK=u,"loading"===t.readyState?t.addEventListener("DOMContentLoaded",function(){"requestIdleCallback"in e?requestIdleCallback(function(){u.init()},{timeout:2e3}):setTimeout(u.init,100)}):setTimeout(u.init,100)}(window,document);
